# 使用说明

## 概述

本文档介绍如何使用懒猫通信（LZC Mobile）系统的各项功能。

## 登录系统

1. 打开浏览器访问 Web 管理面板（默认：`http://localhost:8071`）
2. 系统会自动重定向到 OIDC 登录页面
3. 使用您的 OIDC 账号登录
4. 登录成功后会自动跳转回管理面板

## 仪表盘

仪表盘显示系统的整体状态信息：

- **系统状态**：显示 Asterisk 运行状态（正常/重启中/错误）
- **活动通道数**：当前活动的通话通道数
- **SIP 注册数**：已注册的 SIP 客户端数量
- **运行时间**：Asterisk 服务的运行时间

### 操作按钮

- **重新加载配置**：重新加载 Asterisk 配置文件，使配置变更生效
- **重启 Asterisk**：重启 Asterisk 服务（会中断正在进行的通话）

## Extension 管理

Extension 用于配置 SIP 客户端，允许第三方 SIP 客户端（如 MizuDroid）注册到系统。

### 创建 Extension

1. 点击"新建 Extension"按钮
2. 填写以下信息：
   - **Username**：SIP 用户名（必填）
   - **Secret**：SIP 密码（必填）
   - **CallerID**：主叫号码显示（可选）
   - **Host**：主机地址（默认：dynamic）
   - **Context**：上下文（默认：default）
   - **Transport**：传输协议（默认：TCP）
3. 点击"保存"

保存后，系统会自动重新加载 Asterisk 配置，Extension 即可使用。

### 编辑 Extension

1. 在 Extension 列表中点击"编辑"按钮
2. 修改需要更改的字段
3. 点击"保存"

### 删除 Extension

1. 在 Extension 列表中点击"删除"按钮
2. 确认删除操作

**注意**：如果 Extension 有活跃的 Dongle 绑定，将无法删除。

### 在 SIP 客户端中使用

在您的 SIP 客户端（如 MizuDroid）中配置：

- **服务器地址**：您的服务器 IP 或域名
- **端口**：5060（或您配置的 SIP 端口）
- **用户名**：Extension 的 Username
- **密码**：Extension 的 Secret
- **传输协议**：TCP

## Dongle 管理

Dongle 管理用于配置 USB dongle（GSM Modem）与 Extension 的绑定关系，实现来去电路由。

### 创建 Dongle 绑定

1. 点击"新建绑定"按钮
2. 填写以下信息：
   - **Dongle ID**：Dongle 设备 ID（如 dongle0、dongle1）
   - **Extension**：选择要绑定的 Extension
   - **处理来电**：是否处理来自 dongle 的来电
   - **处理去电**：是否处理发往 dongle 的去电
3. 点击"保存"

保存后，系统会自动生成拨号计划配置并重新加载。

### 发送短信

1. 在 Dongle 绑定列表中，找到要使用的绑定
2. 点击"发短信"按钮
3. 填写：
   - **号码**：接收短信的手机号码
   - **消息**：短信内容
4. 点击"发送"

短信会通过 AMI 命令发送到指定的 dongle 设备。

### 编辑和删除绑定

- **编辑**：点击"编辑"按钮修改绑定配置
- **删除**：点击"删除"按钮删除绑定

## 通知配置

系统支持将收到的短信转发到多个通知渠道。支持的通知渠道包括：

- **SMTP（邮件）**：通过邮件发送通知
- **Slack**：通过 Slack Webhook 发送通知
- **Telegram**：通过 Telegram Bot 发送通知
- **Webhook**：通过自定义 HTTP Webhook 发送通知

### 配置 SMTP 通知

1. 在通知配置页面，选择 SMTP 渠道
2. 填写以下信息：
   - **启用**：勾选以启用此通知渠道
   - **SMTP 服务器**：SMTP 服务器地址
   - **SMTP 端口**：SMTP 端口（通常 25、465 或 587）
   - **用户名**：SMTP 用户名
   - **密码**：SMTP 密码
   - **发件人**：发件人邮箱地址
   - **收件人**：收件人邮箱地址
   - **使用 TLS**：是否使用 TLS/SSL 加密
3. 点击"保存"

### 配置 Slack 通知

1. 在通知配置页面，选择 Slack 渠道
2. 填写以下信息：
   - **启用**：勾选以启用此通知渠道
   - **Webhook URL**：Slack Webhook URL
3. 点击"保存"

### 配置 Telegram 通知

1. 在通知配置页面，选择 Telegram 渠道
2. 填写以下信息：
   - **启用**：勾选以启用此通知渠道
   - **Bot Token**：Telegram Bot Token
   - **Chat ID**：Telegram Chat ID
3. 点击"保存"

### 配置 Webhook 通知

1. 在通知配置页面，选择 Webhook 渠道
2. 填写以下信息：
   - **启用**：勾选以启用此通知渠道
   - **Webhook URL**：自定义 Webhook URL
   - **HTTP 方法**：HTTP 请求方法（默认：POST）
   - **自定义请求头**：JSON 格式的自定义请求头（可选）
3. 点击"保存"

### 多通道通知

系统支持同时启用多个通知渠道。当收到短信时，系统会并行发送通知到所有启用的渠道。

## 日志查看

日志页面用于查看 Asterisk 的运行日志，方便调试和故障排查。

### 查看最近日志

1. 访问日志页面
2. 系统会显示最近的日志行（默认 100 行）
3. 可以滚动查看历史日志

### 实时日志流

1. 在日志页面，系统会自动显示新的日志条目
2. 日志会实时更新，类似于 `tail -f` 的效果

### 日志内容

日志包含以下信息：
- Asterisk 启动和关闭事件
- SIP 注册和注销事件
- 通话建立和结束事件
- Dongle 设备状态变化
- 短信收发事件
- 错误和警告信息

## 系统配置

### SIP 端口配置

系统默认使用 TCP 端口 5060 作为 SIP 端口。可以通过数据库配置修改（需要重启服务）。

### RTP 端口范围

系统默认使用 UDP 端口 40890-40900 作为 RTP 端口范围。可以通过数据库配置修改（需要重启服务）。

## 常见问题

### Extension 无法注册

1. 检查 Extension 配置是否正确
2. 检查 SIP 端口是否正确（默认 5060）
3. 检查防火墙是否开放了 SIP 端口
4. 查看 Asterisk 日志了解详细错误信息

### Dongle 无法发送短信

1. 检查 Dongle 设备是否正确连接
2. 检查 Dongle ID 是否正确
3. 查看 Asterisk 日志了解详细错误信息
4. 确认 dongle 设备已正确配置在 `dongle.conf` 中

### 通知未收到

1. 检查通知渠道是否已启用
2. 检查通知配置是否正确（如 SMTP 服务器、Slack Webhook URL 等）
3. 查看系统日志了解发送状态
4. 测试通知配置（可以手动发送测试短信）

### 系统状态显示错误

1. 检查 AMI 连接是否正常
2. 检查环境变量 `ASTERISK_AMI_USERNAME` 和 `ASTERISK_AMI_PASSWORD` 是否正确
3. 查看容器日志了解详细错误信息

## 最佳实践

1. **定期备份数据库**：数据库文件位于 `/var/lib/lzc-mobile/data.db`，建议定期备份
2. **监控系统状态**：定期检查仪表盘，确保系统正常运行
3. **查看日志**：遇到问题时，首先查看日志页面了解详细错误信息
4. **测试通知**：配置通知渠道后，建议先发送测试短信验证配置是否正确
5. **安全配置**：确保 OIDC 和 AMI 的密码安全，不要泄露

## 技术支持

如遇到问题，可以：

1. 查看日志页面了解详细错误信息
2. 查看部署文档了解配置要求
3. 查看项目架构规划了解系统设计
4. 提交 Issue 到项目仓库
