# 测试清单

本文档列出了系统端到端测试的清单，用于验证各项功能是否正常工作。

## 前置条件

1. Docker 环境已准备就绪
2. USB dongle 设备已连接
3. OIDC 认证服务器已配置
4. 所有必要的环境变量已设置

## 测试项目

### 1. OIDC 登录测试

**测试步骤**：
1. 访问 Web 管理面板（`http://localhost:8071`）
2. 验证是否自动重定向到 OIDC 登录页面
3. 使用有效的 OIDC 账号登录
4. 验证是否成功跳转回管理面板
5. 验证导航栏和页面内容是否正常显示

**预期结果**：
- 能够成功登录
- 登录后能够访问管理面板
- 未登录时访问受保护页面会重定向到登录页

### 2. 状态指示测试

**测试步骤**：
1. 登录后查看导航栏的状态指示器
2. 验证状态颜色是否正确（绿色表示正常）
3. 点击"重启 Asterisk"按钮
4. 观察状态指示器是否变为黄色（重启中）
5. 等待重启完成后，验证状态是否恢复为绿色

**预期结果**：
- 状态指示器正确显示当前状态
- 状态变化实时更新
- 鼠标悬停显示详细状态信息

### 3. Extension 注册测试

**测试步骤**：
1. 在 Extension 管理页面创建一个新的 Extension
2. 记录 Username 和 Secret
3. 在 SIP 客户端（如 MizuDroid）中配置：
   - 服务器地址：容器 IP 或域名
   - 端口：5060
   - 用户名：Extension 的 Username
   - 密码：Extension 的 Secret
   - 传输协议：TCP
4. 尝试注册 SIP 客户端
5. 验证注册是否成功
6. 查看仪表盘的 SIP 注册数是否增加

**预期结果**：
- Extension 创建成功
- SIP 客户端能够成功注册
- 仪表盘显示正确的注册数

### 4. 配置持久化/reload 测试

**测试步骤**：
1. 创建一个 Extension
2. 修改 Extension 配置
3. 点击"保存"
4. 验证配置是否保存成功
5. 重启容器
6. 验证 Extension 配置是否仍然存在
7. 验证 Asterisk 配置是否正确加载

**预期结果**：
- 配置变更后自动重新加载
- 配置持久化到数据库
- 容器重启后配置仍然存在
- Asterisk 配置正确生成

### 5. Dongle 绑定和来电路由测试

**测试步骤**：
1. 创建一个 Extension
2. 创建一个 Dongle 绑定，将 dongle 绑定到 Extension
3. 启用"处理来电"选项
4. 使用另一个电话拨打 dongle 的号码
5. 验证电话是否路由到绑定的 Extension
6. 在 SIP 客户端接听电话
7. 验证通话是否建立

**预期结果**：
- Dongle 绑定创建成功
- 来电能够正确路由到 Extension
- 通话能够正常建立

### 6. Dongle 发送短信测试

**测试步骤**：
1. 创建一个 Dongle 绑定
2. 在 Dongle 管理页面，点击"发短信"
3. 填写接收号码和消息内容
4. 点击"发送"
5. 验证短信是否成功发送
6. 检查接收方是否收到短信

**预期结果**：
- 短信发送命令执行成功
- 接收方能够收到短信
- 系统日志记录发送事件

### 7. 短信接收和通知测试

**测试步骤**：
1. 配置至少一个通知渠道（如 SMTP 或 Slack）
2. 启用通知渠道
3. 向 dongle 发送一条测试短信
4. 验证系统是否收到短信事件
5. 验证通知是否发送到配置的渠道
6. 检查通知内容是否正确

**预期结果**：
- 系统能够接收短信事件
- 通知发送到所有启用的渠道
- 通知内容包含正确的信息（发送方、设备、消息内容）

### 8. 通知多通道测试

**测试步骤**：
1. 配置多个通知渠道（如 SMTP、Slack、Telegram）
2. 启用所有通知渠道
3. 向 dongle 发送一条测试短信
4. 验证所有启用的渠道是否都收到通知
5. 检查每个渠道的通知内容

**预期结果**：
- 所有启用的渠道都收到通知
- 通知内容一致
- 即使某个渠道失败，其他渠道仍能正常发送

### 9. Asterisk 重启测试

**测试步骤**：
1. 确保有活跃的 Extension 注册
2. 在仪表盘点击"重启 Asterisk"按钮
3. 确认重启操作
4. 观察状态指示器变化
5. 等待重启完成
6. 验证 Extension 是否能够重新注册
7. 验证系统功能是否正常

**预期结果**：
- Asterisk 能够正常重启
- 状态指示器正确反映重启状态
- 重启后系统功能正常
- Extension 能够重新注册

### 10. 日志页面测试

**测试步骤**：
1. 访问日志页面
2. 验证是否显示最近的日志行
3. 验证日志是否实时更新
4. 执行一些操作（如创建 Extension、发送短信）
5. 验证日志中是否出现相关事件
6. 验证日志格式是否正确

**预期结果**：
- 日志页面正常显示
- 日志实时更新
- 日志内容准确反映系统事件
- 日志格式清晰易读

### 11. 错误处理测试

**测试步骤**：
1. 尝试创建重复的 Extension Username
2. 尝试删除有活跃绑定的 Extension
3. 尝试使用无效的配置
4. 验证系统是否返回适当的错误信息
5. 验证系统是否能够从错误中恢复

**预期结果**：
- 系统能够检测并报告错误
- 错误信息清晰明确
- 系统不会因为错误而崩溃
- 能够从错误中恢复

## 测试环境要求

- Docker 和 Docker Compose
- USB dongle 设备
- OIDC 认证服务器
- SIP 客户端（用于测试注册）
- 测试手机（用于测试短信和通话）
- 通知渠道测试账号（SMTP、Slack、Telegram 等）

## 测试报告模板

测试完成后，应记录：

1. **测试日期和时间**
2. **测试环境信息**（Docker 版本、系统版本等）
3. **测试结果**：每个测试项目的通过/失败状态
4. **发现的问题**：详细描述任何发现的问题
5. **测试人员**：执行测试的人员

## 持续测试

建议在以下情况下执行测试：

- 新功能开发完成后
- 重大配置变更后
- 系统更新后
- 定期（如每月）执行完整测试
